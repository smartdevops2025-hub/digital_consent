{% extends "base.html" %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid var(--mes-red);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--mes-red);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: var(--mes-dark-gray);
        font-weight: 500;
    }
    
    .user-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    
    .user-table th, .user-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--mes-border);
    }
    
    .user-table th {
        background: var(--mes-red);
        color: white;
        font-weight: 600;
    }
    
    .status-active {
        color: #28a745;
        font-weight: bold;
    }
    
    .status-inactive {
        color: #dc3545;
        font-weight: bold;
    }
    
    .user-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .user-type-admin {
        background: #dc3545;
        color: white;
    }
    
    .user-type-doctor {
        background: #007bff;
        color: white;
    }
    
    .user-type-counsellor {
        background: #28a745;
        color: white;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 0.8rem;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: var(--mes-red); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">üë®‚Äçüíº</span>
        Admin Console - User Management
    </h2>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ users|length }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ users|selectattr('5')|list|length }}</div>
            <div class="stat-label">Active Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ users|selectattr('2', 'equalto', 'counsellor')|list|length }}</div>
            <div class="stat-label">Counsellors</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ users|selectattr('2', 'equalto', 'doctor')|list|length }}</div>
            <div class="stat-label">Doctors</div>
        </div>
    </div>
    
    <!-- Add User Button -->
    <div style="margin-bottom: 1.5rem;">
        <button class="btn-primary" onclick="openAddUserModal()">‚ûï Add New User</button>
    </div>
    
    <!-- Users Table -->
    <div class="table-responsive">
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>User Type</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user[0] }}</td>
                    <td><strong>{{ user[1] }}</strong></td>
                    <td>{{ user[3] }}</td>
                    <td>
                        <span class="user-type-badge user-type-{{ user[2] }}">
                            {{ user[2]|title }}
                        </span>
                    </td>
                    <td>{{ user[4] }}</td>
                    <td>
                        {% if user[5] %}
                            <span class="status-active">‚úÖ Active</span>
                        {% else %}
                            <span class="status-inactive">‚ùå Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ user[7] if user[7] else 'Never' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-secondary" onclick="openEditUserModal({{ user[0] }}, '{{ user[1] }}', '{{ user[2] }}', '{{ user[3] }}', '{{ user[4] }}', {{ user[5] }})">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn-small btn-primary" onclick="openResetPasswordModal({{ user[0] }}, '{{ user[1] }}')">
                                üîë Reset Password
                            </button>
                            {% if user[1] != 'admin' %}
                            <button class="btn-small btn-danger" onclick="deleteUser({{ user[0] }}, '{{ user[1] }}')">
                                üóëÔ∏è Delete
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--mes-red); margin-bottom: 1.5rem;">Add New User</h3>
        <form id="addUserForm">
            <div class="form-group">
                <label for="new_username">Username:</label>
                <input type="text" id="new_username" name="username" required>
            </div>
            <div class="form-group">
                <label for="new_password">Password:</label>
                <input type="password" id="new_password" name="password" required>
            </div>
            <div class="form-group">
                <label for="new_user_type">User Type:</label>
                <select id="new_user_type" name="user_type" required>
                    <option value="counsellor">Counsellor</option>
                    <option value="doctor">Doctor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new_full_name">Full Name:</label>
                <input type="text" id="new_full_name" name="full_name" required>
            </div>
            <div class="form-group">
                <label for="new_department">Department:</label>
                <input type="text" id="new_department" name="department" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                <button type="submit" class="btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--mes-red); margin-bottom: 1.5rem;">Edit User</h3>
        <form id="editUserForm">
            <input type="hidden" id="edit_user_id" name="user_id">
            <div class="form-group">
                <label for="edit_username">Username:</label>
                <input type="text" id="edit_username" name="username" required>
            </div>
            <div class="form-group">
                <label for="edit_user_type">User Type:</label>
                <select id="edit_user_type" name="user_type" required>
                    <option value="counsellor">Counsellor</option>
                    <option value="doctor">Doctor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_full_name">Full Name:</label>
                <input type="text" id="edit_full_name" name="full_name" required>
            </div>
            <div class="form-group">
                <label for="edit_department">Department:</label>
                <input type="text" id="edit_department" name="department" required>
            </div>
            <div class="form-group">
                <label for="edit_is_active">Status:</label>
                <select id="edit_is_active" name="is_active" required>
                    <option value="1">Active</option>
                    <option value="0">Inactive</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                <button type="submit" class="btn-primary">Update User</button>
            </div>
        </form>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--mes-red); margin-bottom: 1.5rem;">Reset Password</h3>
        <form id="resetPasswordForm">
            <input type="hidden" id="reset_user_id" name="user_id">
            <div class="form-group">
                <label for="reset_username">Username:</label>
                <input type="text" id="reset_username" readonly style="background-color: #f8f9fa;">
            </div>
            <div class="form-group">
                <label for="new_password_reset">New Password:</label>
                <input type="password" id="new_password_reset" name="new_password" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
                <button type="submit" class="btn-primary">Reset Password</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Modal functions
    function openAddUserModal() {
        document.getElementById('addUserModal').style.display = 'block';
    }
    
    function closeAddUserModal() {
        document.getElementById('addUserModal').style.display = 'none';
        document.getElementById('addUserForm').reset();
    }
    
    function openEditUserModal(userId, username, userType, fullName, department, isActive) {
        document.getElementById('edit_user_id').value = userId;
        document.getElementById('edit_username').value = username;
        document.getElementById('edit_user_type').value = userType;
        document.getElementById('edit_full_name').value = fullName;
        document.getElementById('edit_department').value = department;
        document.getElementById('edit_is_active').value = isActive ? '1' : '0';
        document.getElementById('editUserModal').style.display = 'block';
    }
    
    function closeEditUserModal() {
        document.getElementById('editUserModal').style.display = 'none';
        document.getElementById('editUserForm').reset();
    }
    
    function openResetPasswordModal(userId, username) {
        document.getElementById('reset_user_id').value = userId;
        document.getElementById('reset_username').value = username;
        document.getElementById('resetPasswordModal').style.display = 'block';
    }
    
    function closeResetPasswordModal() {
        document.getElementById('resetPasswordModal').style.display = 'none';
        document.getElementById('resetPasswordForm').reset();
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        const modals = document.getElementsByClassName('modal');
        for (let modal of modals) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    }
    
    // Form submissions
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/admin/add_user', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User created successfully!');
                closeAddUserModal();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error creating user: ' + error);
        });
    });
    
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/admin/update_user', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User updated successfully!');
                closeEditUserModal();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating user: ' + error);
        });
    });
    
    document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/admin/reset_password', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password reset successfully!');
                closeResetPasswordModal();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error resetting password: ' + error);
        });
    });
    
    function deleteUser(userId, username) {
        if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
            const formData = new FormData();
            formData.append('user_id', userId);
            
            fetch('/admin/delete_user', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error deleting user: ' + error);
            });
        }
    }
</script>
{% endblock %}