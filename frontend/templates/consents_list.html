{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2 style="color: var(--mes-red); margin-bottom: 1.5rem;">All Consents</h2>

    {% if consents %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>MRN</th>
                    <th>Age</th>
                    <th>Consent Type</th>
                    {% if consents and consents[0]|length > 5 %}
                    <th>Procedure</th>
                    {% endif %}
                    {% if consents and consents[0]|length > 7 %}
                    <th>Doctor</th>
                    {% endif %}
                    {% if consents and consents[0]|length > 8 %}
                    <th>Signatory</th>
                    {% endif %}
                    {% if consents and consents[0]|length > 10 %}
                    <th>Counsellor</th>
                    {% endif %}
                    {% if consents and consents[0]|length > 11 %}
                    <th>Date</th>
                    {% endif %}
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for consent in consents %}
                <tr>
                    <td>{{ consent[0] }}</td>  <!-- id -->
                    <td><strong>{{ consent[1] }}</strong></td>  <!-- patient_name -->
                    <td>{{ consent[3] }}</td>  <!-- patient_mrn -->
                    <td>{{ consent[2] }}</td>  <!-- patient_age -->
                    <td>{{ consent[4] }}</td>  <!-- consent_type -->
                    
                    {% if consent|length > 5 %}
                    <td>{{ consent[5] if consent[5] else 'Not specified' }}</td>  <!-- consent_required_for -->
                    {% endif %}
                    
                    {% if consent|length > 7 %}
                    <td>{{ consent[7] if consent[7] else 'Not assigned' }}</td>  <!-- doctor_name -->
                    {% endif %}
                    
                    {% if consent|length > 8 %}
                    <td>{{ consent[8] }} ({{ consent[9] if consent[9] else 'Self' }})</td>  <!-- signatory_name, signatory_relation -->
                    {% endif %}
                    
                    {% if consent|length > 10 %}
                    <td>{{ consent[10] }}</td>  <!-- counsellor_id -->
                    {% endif %}
                    
                    {% if consent|length > 11 %}
                    <td>{{ consent[11] }}</td>  <!-- created_at -->
                    {% endif %}
                    
                    <td>
                        {% if consent|length > 13 and consent[13] %}  <!-- doctor_signature -->
                            <span style="color: #28a745; font-weight: bold;">âœ“ Completed</span>
                        {% elif consent|length > 12 and consent[12] %}  <!-- final_pdf -->
                            <span style="color: #ffc107; font-weight: bold;">Pending Doctor</span>
                        {% else %}
                            <span style="color: #dc3545; font-weight: bold;">Draft</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if consent|length > 12 and consent[12] %}  <!-- final_pdf -->
                            <a href="{{ url_for('download_consent', filename=consent[12]) }}" class="btn-primary" style="padding: 8px 12px; font-size: 0.9rem;">Download PDF</a>
                        {% endif %}
                        {% if consent|length <= 13 or not consent[13] %}  <!-- if no doctor signature -->
                            <a href="{{ url_for('doctor_signature_page', consent_id=consent[0]) }}" class="btn-success" style="padding: 8px 12px; font-size: 0.9rem; margin-top: 5px; display: inline-block;">Doctor Sign</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;">ðŸ“„</div>
        <h3 style="color: var(--mes-dark-gray); margin-bottom: 1rem;">No Consents Found</h3>
        <p>No consent forms have been created yet.</p>
        <a href="{{ url_for('dashboard') }}" class="btn-primary" style="margin-top: 1rem;">Create First Consent</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Quick Statistics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="background: var(--mes-light-gray); padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--mes-red);">
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--mes-red);">{{ consents|length }}</div>
            <div>Total Consents</div>
        </div>
        <div style="background: var(--mes-light-gray); padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">{{ consents|selectattr('13')|list|length if consents and consents[0]|length > 13 else 0 }}</div>
            <div>Completed</div>
        </div>
        <div style="background: var(--mes-light-gray); padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid #ffc107;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">{{ consents|selectattr('12')|rejectattr('13')|list|length if consents and consents[0]|length > 12 else 0 }}</div>
            <div>Pending Doctor</div>
        </div>
    </div>
</div>
{% endblock %}