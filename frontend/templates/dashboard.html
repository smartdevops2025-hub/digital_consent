{% extends "base.html" %}

{% block extra_css %}
<style>
    .template-content-section {
        background: #e7f3ff;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #007bff;
    }
    
    .template-content {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 3px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #495057;
        min-height: 40px;
        border: 1px solid #dee2e6;
        white-space: pre-line;
        line-height: 1.4;
        font-family: 'Helvetica', Arial, sans-serif;
    }
    
    .edit-template-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .edit-template-btn:hover {
        background: #0056b3;
    }
    
    .template-info {
        background: #fff3cd;
        padding: 0.5rem;
        border-radius: 3px;
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #856404;
        border-left: 3px solid #ffc107;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--mes-border);
    }
    
    /* Security: Disable text selection and right-click */
    body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: var(--mes-red); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">üìã</span>
        Create New Digital Consent
    </h2>
    
    {% if consent_types %}
    <form action="{{ url_for('start_consent') }}" method="post" id="consentForm">
        <div class="form-section">
            <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Select Consent Type</h3>
            <div class="form-group">
                <label for="consent_type">Select Consent Type:</label>
                <select name="consent_type" id="consent_type" required onchange="loadConsentTemplate(this.value)">
                    <option value="">-- Select Consent Type --</option>
                    {% for filename, template_data in consent_types.items() %}
                    <option value="{{ filename }}">{{ template_data.display_name }}</option>
                    {% endfor %}
                </select>
                <small style="color: #6c757d; display: block; margin-top: 5px;">
                    Selecting a consent type will auto-fill the template content
                </small>
            </div>
        </div>
        
        <div class="form-section">
            <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Patient Details</h3>
            
            <div class="form-group">
                <label for="patient_name">Patient Full Name:</label>
                <input type="text" name="patient_name" id="patient_name" required placeholder="Enter patient's full name">
            </div>
            
            <div class="form-group">
                <label for="patient_age">Patient Age:</label>
                <input type="number" name="patient_age" id="patient_age" required placeholder="Enter patient's age" min="1" max="120">
            </div>
            
            <div class="form-group">
                <label for="patient_mrn">Medical Record Number (MRN):</label>
                <input type="text" name="patient_mrn" id="patient_mrn" required placeholder="Enter MRN">
            </div>
        </div>
        
        <div class="form-section">
            <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Consent Details</h3>
            
            <div class="form-group">
                <label for="consent_required_for">Consent Required For:</label>
                <input type="text" name="consent_required_for" id="consent_required_for" required 
                       placeholder="e.g., Surgery, LAMA, Anesthesia, Blood Transfusion, etc.">
            </div>
            
            <div class="template-content-section">
                <label>Template Content:</label>
                <div class="template-content" id="procedure_details_display">Template content will appear here when you select a consent type...</div>
                <button type="button" class="edit-template-btn" onclick="enableTemplateEditing()">‚úèÔ∏è Edit Template Content</button>
                <textarea name="procedure_details" id="procedure_details" style="display: none; width: 100%; height: 200px; margin-top: 0.5rem;"></textarea>
                <input type="hidden" name="procedure_details_ml" id="procedure_details_ml">
            </div>
        </div>
        
        <div class="form-section">
            <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Medical Team</h3>
            
            <div class="form-group">
                <label for="patient_doctor">Admitting Doctor:</label>
                <input type="text" name="patient_doctor" id="patient_doctor" required placeholder="Enter doctor's name">
            </div>
        </div>
        
        <div class="form-section">
            <h3 style="color: var(--mes-red); margin-bottom: 1rem;">Signatory Details</h3>
            
            <div class="form-group">
                <label for="signatory_name">Signatory Full Name:</label>
                <input type="text" name="signatory_name" id="signatory_name" required placeholder="Enter signatory's full name">
            </div>
            
            <div class="form-group">
                <label for="signatory_relation">Relationship with Patient:</label>
                <select name="signatory_relation" id="signatory_relation" required>
                    <option value="">-- Select Relationship --</option>
                    <option value="Self">Self (Patient)</option>
                    <option value="Spouse">Spouse</option>
                    <option value="Son">Son</option>
                    <option value="Daughter">Daughter</option>
                    <option value="Father">Father</option>
                    <option value="Mother">Mother</option>
                    <option value="Brother">Brother</option>
                    <option value="Sister">Sister</option>
                    <option value="Guardian">Guardian</option>
                    <option value="Other Relative">Other Relative</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="signatory_mobile">Mobile Number:</label>
                <input type="tel" name="signatory_mobile" id="signatory_mobile" required placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}">
            </div>
        </div>
        
        <button type="submit" class="btn-primary" style="display: flex; align-items: center; gap: 8px; justify-content: center; padding: 15px; font-size: 1.1rem;">
            <span>üëÅÔ∏è</span> Preview Consent
        </button>
    </form>
    {% else %}
    <div style="text-align: center; padding: 2rem; background: var(--mes-light-gray); border-radius: 8px;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
        <h3 style="color: var(--mes-dark-gray); margin-bottom: 1rem;">No Consent Templates Available</h3>
        <p style="margin-bottom: 1.5rem;">Please contact system administrator to add consent template files.</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 style="color: var(--mes-red); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
        <span>‚ö°</span> Quick Actions
    </h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('view_consents') }}" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
            <span>üìä</span> View All Consents
        </a>
        <a href="{{ url_for('logout') }}" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
            <span>üö™</span> Logout
        </a>
    </div>
</div>

<div class="card">
    <h3 style="color: var(--mes-red); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
        <span>üè•</span> System Information
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="background: var(--mes-light-gray); padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--mes-red);">
            <div style="font-size: 2rem; color: var(--mes-red); margin-bottom: 0.5rem;">{{ consent_types|length }}</div>
            <div style="font-weight: 600; color: var(--mes-dark-gray);">Available Templates</div>
        </div>
        <div style="background: var(--mes-light-gray); padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
            <div style="font-size: 2rem; color: #28a745; margin-bottom: 0.5rem;">‚úì</div>
            <div style="font-weight: 600; color: var(--mes-dark-gray);">System Status</div>
        </div>
        <div style="background: var(--mes-light-gray); padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #007bff;">
            <div style="font-size: 2rem; color: #007bff; margin-bottom: 0.5rem;">üîí</div>
            <div style="font-weight: 600; color: var(--mes-dark-gray);">Secure System</div>
        </div>
    </div>
</div>

<script>
    // Security: Disable right-click
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        alert('Right-click is disabled for security reasons.');
    });
    
    // Security: Disable F12, Ctrl+Shift+I, etc.
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') || 
            (e.ctrlKey && e.shiftKey && e.key === 'J') ||
            (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
            alert('Developer tools are disabled for security reasons.');
        }
    });

    function loadConsentTemplate(filename) {
        if (!filename) return;
        
        // Show loading state
        document.getElementById('procedure_details_display').innerHTML = 'Loading template content...';
        document.getElementById('consent_required_for').value = 'Loading...';
        
        fetch(`/api/get_consent_template/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading template:', data.error);
                    document.getElementById('procedure_details_display').innerHTML = 'Error loading template.';
                    document.getElementById('consent_required_for').value = '';
                    return;
                }
                
                // Auto-fill the consent required for field with form name
                const formName = data.form_name;
                document.getElementById('consent_required_for').value = formName;
                
                // Fill the procedure details with template content directly
                const templateContent = data.template_content || 'No template content available.';
                document.getElementById('procedure_details_display').innerHTML = templateContent;
                document.getElementById('procedure_details').value = templateContent;
                document.getElementById('procedure_details_ml').value = templateContent;
                
                // Show success message
                showTemplateInfo(`Template for "${formName}" loaded successfully.`);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('procedure_details_display').innerHTML = 'Error loading template.';
                document.getElementById('consent_required_for').value = '';
            });
    }
    
    function enableTemplateEditing() {
        const displayDiv = document.getElementById('procedure_details_display');
        const textarea = document.getElementById('procedure_details');
        const editBtn = document.querySelector('.edit-template-btn');
        
        // Hide display div, show textarea
        displayDiv.style.display = 'none';
        textarea.style.display = 'block';
        textarea.value = displayDiv.innerHTML;
        
        // Change button to save
        editBtn.innerHTML = 'üíæ Save Template Content';
        editBtn.onclick = saveTemplateEditing;
    }
    
    function saveTemplateEditing() {
        const displayDiv = document.getElementById('procedure_details_display');
        const textarea = document.getElementById('procedure_details');
        const editBtn = document.querySelector('.edit-template-btn');
        
        // Update display div with edited content
        displayDiv.innerHTML = textarea.value;
        
        // Also update the hidden Malayalam field
        document.getElementById('procedure_details_ml').value = textarea.value;
        
        // Hide textarea, show display div
        textarea.style.display = 'none';
        displayDiv.style.display = 'block';
        
        // Change button back to edit
        editBtn.innerHTML = '‚úèÔ∏è Edit Template Content';
        editBtn.onclick = enableTemplateEditing;
        
        // Show success message
        showTemplateInfo('Template content updated successfully.');
    }
    
    function showTemplateInfo(message) {
        // Create or update template info display
        let infoDiv = document.getElementById('template-info');
        if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'template-info';
            infoDiv.className = 'template-info';
            // Insert after the consent type select
            const consentTypeGroup = document.getElementById('consent_type').closest('.form-group');
            consentTypeGroup.parentNode.insertBefore(infoDiv, consentTypeGroup.nextSibling);
        }
        infoDiv.innerHTML = `‚úÖ ${message}`;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            infoDiv.style.opacity = '0';
            setTimeout(() => infoDiv.remove(), 1000);
        }, 5000);
    }
    
    // Initialize form validation
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('consentForm');
        
        form.addEventListener('submit', function(e) {
            // Basic validation to ensure all required fields are filled
            const requiredFields = form.querySelectorAll('[required]');
            let allValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    allValid = false;
                    field.style.borderColor = 'red';
                } else {
                    field.style.borderColor = '';
                }
            });
            
            // Check if template content is loaded
            const procedureDetails = document.getElementById('procedure_details').value;
            if (!procedureDetails || procedureDetails === 'No template content available.') {
                alert('Please select a consent type to load the template content.');
                allValid = false;
            }
            
            if (!allValid) {
                e.preventDefault();
                alert('Please fill in all required fields and select a consent type.');
            }
        });
        
        // Clear any existing template info
        const existingInfo = document.getElementById('template-info');
        if (existingInfo) {
            existingInfo.remove();
        }
    });
</script>
{% endblock %}